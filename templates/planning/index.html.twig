{% extends 'base.html.twig' %}

{% block title %}Planning des Formations
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			padding: 0;
			overflow: hidden;
		}
		.container-fluid {
			height: calc(100vh - 60px);
			width: 100vw;
			padding: 0;
			margin: 0;
			display: flex;
			flex-direction: column;
			overflow: hidden;
		}
		.gantt-wrapper {
			flex: 1;
			display: flex;
			flex-direction: column;
		}
		.gantt-scroll-body {
			flex: 1;
			overflow: auto;
			cursor: grab;
			position: relative;
			scrollbar-width: none;
			-ms-overflow-style: none;
		}
		.gantt-scroll-body::-webkit-scrollbar {
			display: none;
		}
		.gantt-header {
			overflow: auto;
			cursor: grab;
			position: relative;
			top: 0;
			background: white;
			z-index: 50;
			border-bottom: 2px solid #ccc;
			overflow-x: auto;
			overflow-y: hidden;
			white-space: nowrap;
			scrollbar-width: none;
			-ms-overflow-style: none;
		}
		.gantt-header::-webkit-scrollbar {
			display: none;
		}
		.gantt-container {
			position: relative;
			min-width: calc(52 * 7 * 4.3px);
		}
		.timeline-years,
		.timeline-months,
		.timeline-total-stagiaires {
			display: flex;
			height: 20px;
			border-top: 1px solid black;
			width: 8740px;

		}
		.timeline-weeks {
			display: flex;
			height: 20px;

		}
		.timeline-active-stagiaires {
			border-bottom: 2px solid #23395d;
			display: flex;
			height: 20px;
			border-top: 1px solid;
			width: 8740px;

		}
		.year-column {
			font-weight: bold;
			background: #f8f9fc;
			border-top: 3px solid #23395d;
			border-right: 1px solid black;
			display: flex;
			align-items: center;
			justify-content: center;
			min-width: 1200px;
		}
		.month-column {
			min-width: 100px;
			font-size: 12px;
			border: 1px solid #999;
			display: flex;
			align-items: center;
			justify-content: center;
			border-right: 1px solid black;
			border-bottom: 1px solid black;
		}
		.week-column,
		.stagiaires-column {
			min-width: 23px;
			font-size: 11px;
			border-right: 1px solid #eee;
			display: flex;
			align-items: center;
			justify-content: center;
			border-right: 1px solid black;
		}
		.formation-name {
			position: sticky;
			left: 0;
			background: white;
			z-index: 10;
			border-right: 1px solid #ddd;
			padding-left: 5px;
			font-weight: bold;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}
		.gantt-row {
			position: relative;
			height: 30px;
		}
		.formation-bar {
			position: absolute;
			height: 30px;
			background-color: #4e73df;
			border-radius: 3px;
			top: 5px;
			cursor: pointer;
			color: white;
			font-size: 10px;
			padding: 2px;
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
		}
		.formation-bar:hover {
			z-index: 10;
			overflow: visible;
			background-color: #3a5bbf;
		}
		.formation-validated {
			background-color: rgb(245, 7, 19);
		}
		.formation-pending {
			background-color: ;
		}
		.interruption {
			position: absolute;
			height: 30px;
			background-color: #e74a3b;
			opacity: 0.7;
			top: 5px;
			z-index: 5;
			border-radius: 3px;
		}
		.entreprise-period {
			position: absolute;
			height: 30px;
			background-color: #1cc88a;
			border-radius: 3px;
			top: 5px;
			z-index: 4;
		}
		.holiday-marker,
		.today-marker {
			position: absolute;
			top: 0;
			height: 800px;
			width: 2px;
			z-index: 5;
		}
		.holiday-marker {
			background-color: red;
		}
		.today-marker {
			background-color: blue;

		}

		.bar-label {
			font-size: 10px;
			line-height: 1.1;
			white-space: normal;
			word-break: break-word;
			padding: 2px;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<h1 class="h3 mb-4 text-gray-800 text-center">Planning des Formations</h1>
		<div class="gantt-wrapper">
			<div class="gantt-header">
				<div class="timeline-years">
					{% for year, weeks in yearly_weeks %}
						<div class="year-column" style="width: {{ weeks * 30 }}px">{{ year }}</div>
					{% endfor %}
				</div>
				<div class="timeline-months">
					{% for month in months %}
						<div class="month-column">{{ month|split('-')[1]|month_name_fr }}</div>
					{% endfor %}
				</div>
				<div class="timeline-weeks">
					{% for week in all_weeks %}
						<div class="week-column">{{ week.number }}</div>
					{% endfor %}
				</div>
				<div class="timeline-total-stagiaires">
					{% for week in all_weeks %}
						<div class="stagiaires-column">{{ week.total_stagiaires ?? '' }}</div>
					{% endfor %}
				</div>
				<div class="timeline-active-stagiaires">
					{% for week in all_weeks %}
						<div class="stagiaires-column">{{ week.active_stagiaires ?? '' }}</div>
					{% endfor %}
				</div>
			</div>

			<div class="gantt-scroll-body" id="gantt-scroll-body">
				<div class="gantt-container">
					{% for group, formations in grouped_formations %}
						<div id="group-{{ group|e('html_attr') }}">
							{% for formation in formations %}
								<div
									class="gantt-row mb-2">
									{#<div class="formation-name">{{ formation.nom }}</div>#}
									<div style="position: relative; height: 50%;">
										<a class="formation-bar {{ formation.etat == 'validée' ? 'formation-validated' : 'formation-pending' }}" href="{{ path('app_formation_edit', {'id': formation.id}) }}" data-start="{{ formation.dateDebut|date('Y-m-d') }}" data-end="{{ formation.dateFin|date('Y-m-d') }}">
											<span class="bar-label">
												{{ formation.nom }}<br>
												{{ formation.nombreHeures }}h<br>
												Semaine(s) actives:
												{{ formation.activeStagiaires }}
											</span>
										</a>

										{% for interruption in formation.interruptions %}
											<div class="interruption" data-start="{{ interruption.dateDebut|date('Y-m-d') }}" data-end="{{ interruption.dateFin|date('Y-m-d') }}"></div>
										{% endfor %}

										{% for periode in formation.periodEnEntreprises %}
											<div class="entreprise-period" data-start="{{ periode.dateDebut|date('Y-m-d') }}" data-end="{{ periode.dateFin|date('Y-m-d') }}">
												<span class="bar-label">Stage</span>
											</div>
										{% endfor %}
									</div>
								</div>
							{% endfor %}
						</div>
					{% endfor %}

					{% for holiday in holidays %}
						<div class="holiday-marker" data-start="{{ holiday.date|date('Y-m-d') }}" title="Jour férié: {{ holiday.nom }} ({{ holiday.date|date('d/m/Y') }})"></div>
					{% endfor %}
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		const ganttStartDate = new Date('{{ start_date|date("Y-m-d") }}');
const dayWidth = 4.3;

function positionGanttElements() {
const elements = document.querySelectorAll('.formation-bar, .interruption, .entreprise-period, .holiday-marker');

elements.forEach(el => {
const start = new Date(el.dataset.start);
const end = el.dataset.end ? new Date(el.dataset.end) : start;

const durationDays = Math.max(1, Math.floor((end - start) / (1000 * 60 * 60 * 24)));
const offsetDays = Math.floor((start - ganttStartDate) / (1000 * 60 * 60 * 24));

const left = offsetDays * dayWidth;
const width = durationDays * dayWidth;

el.style.left = `${left}px`;
if (!el.classList.contains('holiday-marker')) {
el.style.width = `${width}px`;
}
});
}

document.addEventListener('DOMContentLoaded', positionGanttElements);

const ganttScroll = document.getElementById('gantt-scroll-body');
const ganttHeader = document.querySelector('.gantt-header');
let isDragging = false,
startX,
startY,
scrollLeft,
scrollTop;

ganttScroll.addEventListener('mousedown', (e) => {
isDragging = true;
startX = e.pageX - ganttScroll.offsetLeft;
startY = e.pageY - ganttScroll.offsetTop;
scrollLeft = ganttScroll.scrollLeft;
scrollTop = ganttScroll.scrollTop;
ganttScroll.style.cursor = 'grabbing';
});
document.addEventListener('mouseup', () => {
isDragging = false;
ganttScroll.style.cursor = 'grab';
});
document.addEventListener('mousemove', (e) => {
if (! isDragging) 
return;



e.preventDefault();
const x = e.pageX - ganttScroll.offsetLeft;
const y = e.pageY - ganttScroll.offsetTop;
const walkX = (x - startX) * 2;
const walkY = (y - startY) * 2;
ganttScroll.scrollLeft = scrollLeft - walkX;
ganttScroll.scrollTop = scrollTop - walkY;
ganttHeader.scrollLeft = ganttScroll.scrollLeft;
});
ganttScroll.addEventListener('scroll', () => {
ganttHeader.scrollLeft = ganttScroll.scrollLeft;
});
	</script>
{% endblock %}
