{# {% extends 'base.html.twig' %}

{% block title %}Planning des Formations
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.gantt-wrapper {
			position: relative;
			overflow: hidden;
		}

		.gantt-header {
			position: sticky;
			top: 0;
			background: white;
			z-index: 100;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
			width: 3500px;
		}

		.gantt-scroll-body {
			overflow: auto;
			height: 80vh;
		}

		.gantt-container {
			font-family: Arial, sans-serif;
			min-width: max-content;

		}

		.timeline-years,
		.timeline-months,
		.timeline-weeks {
			display: flex;
			height: 30px;
			border-bottom: 1px solid #ddd;
		}

		.year-column {
			font-weight: bold;
			background: #f8f9fc;
			display: flex;
			align-items: center;
			justify-content: center;
			border-right: 1px solid #ddd;
			position: relative;
		}

		.month-column {
			display: flex;
			align-items: center;
			justify-content: center;
			border-right: 1px solid #eee;
			font-size: 12px;
			position: relative;
		}

		.week-column {
			font-size: 10px;
			border-right: 1px solid #f5f5f5;
			min-width: 30px;
			text-align: center;
			padding-top: 15px;
		}

		.gantt-row {
			display: flex;
			align-items: center;
			height: 40px;
			border-bottom: 1px solid #eee;
			position: relative;
		}

		.formation-name {
			width: 250px;
			padding: 5px 10px;
			position: sticky;
			left: 0;
			background: white;
			z-index: 10;
			border-right: 1px solid #eee;
		}

		.formation-bar-container {
			position: relative;
			min-width: calc(100% - 250px);
			height: 100%;
		}

		.formation-bar {
			position: absolute;
			height: 25px;
			background-color: #4e73df;
			border-radius: 3px;
			top: 7px;
			cursor: pointer;
			display: flex;
			align-items: center;
			padding: 0 5px;
			color: white;
			font-size: 11px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			text-decoration: none;
		}

		.formation-bar:hover {
			opacity: 0.9;
		}

		.formation-validated {
			background-color: #28a745;
		}
		.formation-pending {
			background-color: orange;
		}

		.interruption {
			position: absolute;
			height: 10px;
			background-color: #e74a3b;
			opacity: 0.7;
			top: 15px;
			border-radius: 2px;
		}

		.entreprise-period {
			position: absolute;
			height: 8px;
			background-color: #1cc88a;
			border-radius: 3px;
			top: 28px;
		}

		.holiday-marker,
		.today-marker {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 2px;
			z-index: 5;
		}

		.holiday-marker {
			background-color: rgba(255, 0, 0, 0.5);
		}
		.today-marker {
			background-color: blue;
		}

		.group-header {
			background-color: #f8f9fa;
			font-weight: bold;
			padding: 8px 10px;
			cursor: pointer;
			position: sticky;
			left: 0;
			z-index: 20;
			border-bottom: 1px solid #ddd;
		}

		.group-collapsed .gantt-row {
			display: none;
		}

		/* Week numbering style */
		.week-number {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			text-align: center;
			font-size: 9px;
			color: #666;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container-fluid" style="width:1600px;">
		<h1 class="h3 mb-4 text-gray-800 text-center">Planning des Formations</h1>

		<div
			class="gantt-wrapper">
			<!-- Sticky Header -->
			<div
				class="gantt-header">
				<!-- Year row -->
				<div class="timeline-years">
					{% for year, weeks in years_weeks %}
						<div class="year-column" style="width: {{ weeks * 30 }}px">
							{{ year }}
						</div>
					{% endfor %}
				</div>

				<!-- Month row -->
				<div class="timeline-months">
					{% for month in months %}
						<div class="month-column" style="width: {{ month.weeks * 30 }}px">
							{{ month.name }}
						</div>
					{% endfor %}
				</div>

				<!-- Week row -->
				<div class="timeline-weeks">
					{% for week in weeks %}
						<div class="week-column" style="width: 30px">
							<div class="week-number">{{ week.number }}</div>
						</div>
					{% endfor %}
				</div>
			</div>

			<!-- Scrollable Gantt Body -->
			<div class="gantt-scroll-body" id="gantt-scroll-body">
				<div class="gantt-container">
					{% for group, formations in grouped_formations %}
						<div class="group-header" onclick="toggleGroup('{{ group|e('html_attr') }}')">
							{{ group }}
						</div>
						<div id="group-{{ group|e('html_attr') }}">
							{% for formation in formations %}
								<div class="gantt-row">
									<div class="formation-name">
										{{ formation.nom }}<br>
										<small>{{ formation.titreProfessionnel }}</small>
									</div>
                  
									<div class="formation-bar-container">
										{% set barLeft = date_service.getWeeksBetween(start_date, formation.dateDebut) * 30 %}
										{% set barWidth = date_service.getWeeksBetween(formation.dateDebut, formation.dateFin) * 30 %}
									
										{# <a href="{{ path('app_formation_show', {'id': formation.id}) }}" class="formation-bar {{ formation.etat == 'validée' ? 'formation-validated' : 'formation-pending' }}" style="left: {{ barLeft }}px; width: {{ barWidth }}px" title="{{ formation.nom }} - {{ formation.dateDebut|date('d/m/Y') }} au {{ formation.dateFin|date('d/m/Y') }}">
											{{ formation.nom }}
										</a>

										{% for interruption in formation.interruptions %}
											{% set intLeft = date_service.getWeeksBetween(formation.dateDebut, interruption.dateDebut) * 30 %}
											{% set intWidth = date_service.getWeeksBetween(interruption.dateDebut, interruption.dateFin) * 30 %}
											<div class="interruption" style="left: {{ barLeft + intLeft }}px; width: {{ intWidth }}px" title="Interruption: {{ interruption.dateDebut|date('d/m/Y') }} au {{ interruption.dateFin|date('d/m/Y') }}"></div>
										{% endfor %}

										{% for periode in formation.periodEnEntreprises %}
											{% set entLeft = date_service.getWeeksBetween(start_date, periode.dateDebut) * 30 %}
											{% set entWidth = date_service.getWeeksBetween(periode.dateDebut, periode.dateFin) * 30 %}
											<div class="entreprise-period" style="left: {{ entLeft }}px; width: {{ entWidth }}px" title="Période en entreprise: {{ periode.dateDebut|date('d/m/Y') }} au {{ periode.dateFin|date('d/m/Y') }}"></div>
										{% endfor %}
									</div>
								</div>
							{% endfor %}
						</div>
					{% endfor %}

					{% for holiday in holidays %}
						{% set left = date_service.getWeeksBetween(start_date, holiday.date) * 30 %}
						<div class="holiday-marker" style="left: {{ left }}px" title="Jour férié: {{ holiday.nom }} ({{ holiday.date|date('d/m/Y') }})"></div>
					{% endfor %}

					<div class="today-marker" style="left: {{ current_week_position }}px" title="Aujourd'hui"></div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		function toggleGroup(groupId) {
const group = document.getElementById('group-' + groupId);
group.classList.toggle('group-collapsed');
}

// Mouse drag scroll
const ganttScroll = document.getElementById('gantt-scroll-body');
let isDragging = false;
let startX,
startY,
scrollLeft,
scrollTop;

ganttScroll.addEventListener('mousedown', (e) => {
isDragging = true;
startX = e.pageX - ganttScroll.offsetLeft;
startY = e.pageY - ganttScroll.offsetTop;
scrollLeft = ganttScroll.scrollLeft;
scrollTop = ganttScroll.scrollTop;
});

document.addEventListener('mouseup', () => {
isDragging = false;
});

document.addEventListener('mousemove', (e) => {
if (! isDragging) 
return;



e.preventDefault();
const x = e.pageX - ganttScroll.offsetLeft;
const y = e.pageY - ganttScroll.offsetTop;
const walkX = (x - startX);
const walkY = (y - startY);
ganttScroll.scrollLeft = scrollLeft - walkX;
ganttScroll.scrollTop = scrollTop - walkY;
});
	</script>
{% endblock %} #}


{% extends 'base.html.twig' %}

{% block title %}Planning des Formations
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.navbar {
			position: sticky;
			top: 0;
			z-index: 1000;
			background: white;
		}

		.gantt-wrapper {
			border: 1px solid #ccc;
			position: relative;
			overflow: hidden;
		}

		.gantt-header {
			position: sticky;
			top: 60px;
			background: white;
			z-index: 100;
			width: 100%;
		}

		.gantt-scroll-body {
			overflow-x: auto;
			overflow-y: visible;
			max-height: none;
			cursor: grab;
		}

		.timeline-years,
		.timeline-months,
		.timeline-weeks,
		.timeline-stagiaires {
			display: flex;
			height: 30px;
			border-bottom: 1px solid #ddd;
		}

		.timeline-stagiaires {
			border-bottom: 2px solid #23395d;
		}

		.year-column {
			font-weight: bold;
			background: #f8f9fc;
			border-top: 3px solid #23395d;
			display: flex;
			align-items: center;
			justify-content: center;
			border-right: 1px solid black;
		}

		.month-column {
			min-width: 80px;
			font-size: 12px;
			border-top: 1px solid black;
			border-bottom: 1px solid black;
			display: flex;
			align-items: center;
			justify-content: center;
			border-right: 1px solid #ddd;
		}

		.week-column,
		.stagiaires-column {
			min-width: 30px;
			font-size: 10px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-right: 1px solid #eee;
		}

		.formation-bar {
			position: absolute;
			height: 20px;
			background-color: #4e73df;
			border-radius: 3px;
			top: 5px;
			cursor: pointer;
			color: white;
			font-size: 10px;
			padding: 2px;
			overflow: hidden;
			white-space: nowrap;
			text-overflow: ellipsis;
		}

		.formation-bar:hover {
			z-index: 10;
			overflow: visible;
			background-color: #3a5bbf;
		}

		.formation-validated {
			background-color: #28a745;
		}

		.formation-pending {
			background-color: orange;
		}

		.holiday-marker,
		.today-marker {
			position: absolute;
			top: 0;
			height: 100%;
			width: 2px;
			z-index: 5;
		}

		.holiday-marker {
			background-color: red;
		}

		.today-marker {
			background-color: blue;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<h1 class="h3 mb-4 text-gray-800 text-center">Planning des Formations</h1>

		<div class="gantt-wrapper">
			<div class="gantt-header">
				<div class="timeline-years">
					{% for year, weeks in yearly_weeks %}
						<div class="year-column" style="width: {{ weeks * 30 }}px">{{ year }}</div>
					{% endfor %}
				</div>

				<div class="timeline-months">
					{% for month in months %}
						<div class="month-column">{{ month|split('-')[1]|month_name_fr }}</div>
					{% endfor %}
				</div>

				<div class="timeline-weeks">
					{% for week in all_weeks %}
						<div class="week-column" title="Semaine {{ week.number }}{% if week.iso_year != week.display_year %} ({{ week.iso_year }}){% endif %}">
							{{ week.number }}
						</div>
					{% endfor %}
				</div>

				<div class="timeline-stagiaires">
					{% for week in all_weeks %}
						<div class="stagiaires-column">{{ week.total_stagiaires ?? '' }}</div>
					{% endfor %}
				</div>
				<div class="timeline-stagiaires">
					{% for week in all_weeks %}
						<div class="stagiaires-column">{{ week.active_stagiaires ?? '' }}</div>
					{% endfor %}
				</div>
			</div>

			<div class="gantt-scroll-body" id="gantt-scroll-body">
				<div class="gantt-container">
					{% for group, formations in grouped_formations %}
						<div id="group-{{ group|e('html_attr') }}">
							{% for formation in formations %}
								<div class="gantt-row" style="height: 30px; position: relative;">
									<div class="formation-name" style="position: sticky; left: 0; background: white; z-index: 10; width: 250px;">
										{{ formation.nom }}<br>
										<small>{{ formation.titreProfessionnel }}</small>
									</div>

									<div style="position: relative; height: 100%; margin-left: 250px;">
										{% set barLeft = date_service.getWeeksBetween(start_date, formation.dateDebut) * 30 %}
										{% set barWidth = date_service.getWeeksBetween(formation.dateDebut, formation.dateFin) * 30 %}
										<a href="{{ path('app_formation_edit', {'id': formation.id}) }}" class="formation-bar {{ formation.etat == 'validée' ? 'formation-validated' : 'formation-pending' }}" style="left: {{ barLeft }}px; width: {{ barWidth }}px" title="{{ formation.nom }} | {{ formation.dateDebut|date('d/m/Y') }} - {{ formation.dateFin|date('d/m/Y') }} | {{ formation.nombreHeures }}h">
											{{ formation.nom }}
											({{ formation.nombreHeures }}h)
										</a>
									</div>
								</div>
							{% endfor %}
						</div>
					{% endfor %}

					{% for holiday in holidays %}
						{% set left = date_service.getOffsetDaysBetween(start_date, holiday.date) * dayWidth %}
						<div class="holiday-marker" style="left: {{ left }}px" title="Jour férié: {{ holiday.nom }} ({{ holiday.date|date('d/m/Y') }})"></div>
					{% endfor %}

					<div class="today-marker" style="left: {{ current_day_position }}px" title="Aujourd'hui"></div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		const ganttScroll = document.getElementById('gantt-scroll-body');
let isDragging = false;
let startX,
startY,
scrollLeft,
scrollTop;

ganttScroll.addEventListener('mousedown', (e) => {
isDragging = true;
ganttScroll.style.cursor = 'grabbing';
startX = e.pageX - ganttScroll.offsetLeft;
startY = e.pageY - ganttScroll.offsetTop;
scrollLeft = ganttScroll.scrollLeft;
scrollTop = ganttScroll.scrollTop;
});

document.addEventListener('mouseup', () => {
isDragging = false;
ganttScroll.style.cursor = 'grab';
});

document.addEventListener('mousemove', (e) => {
if (! isDragging) 
return;


e.preventDefault();
const x = e.pageX - ganttScroll.offsetLeft;
const y = e.pageY - ganttScroll.offsetTop;
const walkX = (x - startX) * 2;
const walkY = (y - startY) * 2;
ganttScroll.scrollLeft = scrollLeft - walkX;
ganttScroll.scrollTop = scrollTop - walkY;
});
	</script>
{% endblock %}


{# {% extends 'base.html.twig' %}

{% block title %}Planning des Formations
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.2/dist/frappe-gantt.min.css">
	<style>
		.gantt-container {
			margin: 0;
			font-family: Arial, sans-serif;
			/* overflow-x: auto;
            overflow-y: auto; */
			height: 60vh;
			position: relative;
			width: 1490px;
		}

		.timeline-header {
			position: sticky;
			top: 0;
			background: white;
			z-index: 100;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		}

		.timeline-years,
		.timeline-months,
		.timeline-days {
			display: flex;
			height: 50px;
			border-bottom: 1px solid #ddd;
		}

		.year-column {
			font-weight: bold;
			border-right: 1px solid #ddd;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #f8f9fc;
		}

		.month-column {
			min-width: 62px;
			font-size: 12px;
			border-right: 1px solid #eee;
			display: flex;
			align-items: center;
			justify-content: center;

		}

		.day-column {
			/* width: {{ dayWidth }}px; */
			font-size: 10px;
			text-align: left;
			border-right: 15px solid #eee;

		}

		.gantt-row {
			display: flex;
			align-items: center;
			height: 130px;
			border-bottom: 1px solid #eee;
			position: relative;
			background: #f8f9fc;
		}

		.formation-name {
			width: 250px;
			padding: 5px 10px;
			position: sticky;
			left: 0;
			background: #;
			z-index: 10;
			cursor: pointer;
		}

		.formation-bar-container {
			margin-left: 0;
			position: relative;
			min-width: calc(100% - 0px);
		}

		.formation-bar {
			position: absolute;
			height: 20px;
			background-color: #4e73df;
			border-radius: 3px;
			top: 10px;
		}

		.formation-validated {
			background-color: #28a745;
		}
		.formation-pending {
			background-color: orange;
		}
		.interruption {
			position: absolute;
			height: 20px;
			background-color: #e74a3b;
			opacity: 0.7;
			top: 10px;
		}
		.entreprise-period {
			position: absolute;
			height: 10px;
			background-color: #1cc88a;
			border-radius: 3px;
			top: 35px;
		}

		.holiday-marker,
		.today-marker {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 2px;
			z-index: 5;
		}
		.holiday-marker {
			background-color: red;
		}
		.today-marker {
			background-color: blue;
		}

		.group-header {
			background-color: ;
			font-weight: bold;
			padding: 5px 10px;
			cursor: pointer;
		}

		.group-collapsed .gantt-row {
			display: none;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<h1 class="h3 mb-4 text-gray-800 text-center">Planning des Formations</h1>
		<div
			class="gantt-container">

			<!-- Timeline Header -->
			<div
				class="timeline-header">


				<!-- Année ou years -->
				<div class="timeline-years">
					{% set currentYear = '' %}
					{% for month in months %}
						{% set year = month|split('-')[0] %}
						{% if year != currentYear %}
							<div class="year-column" style="width: {{ months_in_year[year] * 62 }}px">{{ year }}</div>
							{% set currentYear = year %}
						{% endif %}
					{% endfor %}
				</div>


				<!-- Mois ou Months -->
				<div class="timeline-months">
					{% for month in months %}
						<div class="month-column">{{ month|split('-')[1]|month_name_fr }}</div>
					{% endfor %}
				</div>


				<!-- Jours or Days -->
				<div class="timeline-days">
					{% for month in months %}
						{% for day in 1..days_in_months[month] %}
							<div class="day-column">{{ day }}</div>
						{% endfor %}
					{% endfor %}
				</div>
			</div>

			<!-- Gantt Rows -->
			{% for group, formations in grouped_formations %}
				<div class="group-header" onclick="toggleGroup('{{ group|e('html_attr') }}')">{{ group }}</div>
				<div id="group-{{ group|e('html_attr') }}">
					{% for formation in formations %}


						<!-- Gantt rows sur chart -->
						<div class="gantt-row">
							<div class="formation-name">
								{{ formation.nom }}<br>
								<small>{{ formation.titreProfessionnel }}</small>
							</div>

							<!-- Gantt bar sur chart -->
							<div class="formation-bar-container">
								{% set barLeft = date_service.getDaysBetween(start_date, formation.dateDebut) * dayWidth %}
								{% set barWidth = date_service.getDaysBetween(formation.dateDebut, formation.dateFin) * dayWidth %}
								<div class="formation-bar {{ formation.etat == 'validée' ? 'formation-validated' : 'formation-pending' }}" style="left: {{ barLeft }}px; width: {{ barWidth }}px"></div>


								<!-- interruption -->
								{% for interruption in formation.interruptions %}
									{% set intLeft = date_service.getDaysBetween(formation.dateDebut, interruption.dateDebut) * dayWidth %}
									{% set intWidth = date_service.getDaysBetween(interruption.dateDebut, interruption.dateFin) * dayWidth %}
									<div class="interruption" style="left: {{ barLeft + intLeft }}px; width: {{ intWidth }}px"></div>
								{% endfor %}


								<!-- Period en Entreprises -->
								{% for periode in formation.periodEnEntreprises %}
									{% set entLeft = date_service.getDaysBetween(start_date, periode.dateDebut) * dayWidth %}
									{% set entWidth = date_service.getDaysBetween(periode.dateDebut, periode.dateFin) * dayWidth %}
									<div class="entreprise-period" style="left: {{ entLeft }}px; width: {{ entWidth }}px"></div>
								{% endfor %}
							</div>
						</div>
					{% endfor %}
				</div>
			{% endfor %}

			<!-- Holiday Markers -->
			<!-- Holiday Markers -->
			{% for holiday in holidays %}
				{% set left = date_service.getOffsetDaysBetween(start_date, holiday.date) * dayWidth %}
				<div class="holiday-marker" style="left: {{ left }}px" title="Jour férié: {{ holiday.nom }} ({{ holiday.date|date('d/m/Y') }})"></div>
			{% endfor %}

			<!-- Today Marker -->
			<div class="today-marker" style="left: {{ current_day_position }}px" title="Aujourd'hui"></div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		function toggleGroup(groupId) {
const group = document.getElementById('group-' + groupId);
group.classList.toggle('group-collapsed');
}
	</script>
{% endblock %} #}
