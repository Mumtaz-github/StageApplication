{% extends 'base.html.twig' %}

{% block title %}Planning des Formations
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		/* .gantt-wrapper {
			border: 1px solid #ccc;
			position: relative;
		} */

		.gantt-header {
			position: sticky;
			top: 0;
			background: white;
			z-index: 100;
		}

		.gantt-scroll-body {
			overflow: visible;
			max-height: none;
			cursor: grab;
		}

		.gantt-container {
			font-family: Arial, sans-serif;
			min-width: max-content;
			width: fit-content;
		}

		.timeline-years,
		.timeline-months,
		.timeline-days {
			display: flex;
			height: 50px;
			border-bottom: 1px solid #ddd;
		}

		.year-column,
		.month-column,
		.day-column {
			display: flex;
			align-items: center;
			justify-content: center;
			border-right: 1px solid #eee;
		}

		.year-column {
			font-weight: bold;
			background: #f8f9fc;
			width: auto;
		}

		.month-column {
			min-width: 62px;
			font-size: 12px;
		}

		.day-column {
			font-size: 10px;
			border-right: 15px solid #eee;
		}

		.gantt-row {
			display: flex;
			align-items: center;
			height: 130px;
			border-bottom: 1px solid #eee;
			background: #f8f9fc;
		}

		.formation-name {
			width: 250px;
			padding: 5px 10px;
			position: sticky;
			left: 0;
			background: white;
			z-index: 10;
		}

		.formation-bar-container {
			position: relative;
			min-width: calc(100% - 250px);
		}

		.formation-bar {
			position: absolute;
			height: 20px;
			background-color: #4e73df;
			border-radius: 3px;
			top: 10px;
			cursor: pointer;
		}

		.formation-validated {
			background-color: #28a745;
		}
		.formation-pending {
			background-color: orange;
		}

		.interruption {
			position: absolute;
			height: 20px;
			background-color: #e74a3b;
			opacity: 0.7;
			top: 10px;
		}

		.entreprise-period {
			position: absolute;
			height: 10px;
			background-color: #1cc88a;
			border-radius: 3px;
			top: 35px;
		}

		.holiday-marker,
		.today-marker {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 2px;
			z-index: 5;
		}

		.holiday-marker {
			background-color: red;
		}
		.today-marker {
			background-color: blue;
		}

		.group-header {
			background-color: #e2e6ea;
			font-weight: bold;
			padding: 5px 10px;
			cursor: pointer;
		}

		.group-collapsed .gantt-row {
			display: none;
		}

	</style>
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<h1 class="h3 mb-4 text-gray-800 text-center">Planning des Formations</h1>

		<div
			class="gantt-wrapper">
			<!-- Sticky Header -->
			<div class="gantt-header">
				<div class="timeline-years">
					{% set currentYear = '' %}
					{% for month in months %}
						{% set year = month|split('-')[0] %}
						{% if year != currentYear %}
							<div class="year-column" style="width: {{ months_in_year[year] * 62 }}px">{{ year }}</div>
							{% set currentYear = year %}
						{% endif %}
					{% endfor %}
				</div>

				<div class="timeline-months">
					{% for month in months %}
						<div class="month-column">{{ month|split('-')[1]|month_name_fr }}</div>
					{% endfor %}
				</div>

				<div class="timeline-days">
					{% for month in months %}
						{% for day in 1..days_in_months[month] %}
							<div class="day-column">{{ day }}</div>
						{% endfor %}
					{% endfor %}
				</div>
			</div>

			<!-- Scrollable Gantt Body -->
			<div class="gantt-scroll-body" id="gantt-scroll-body">
				<div class="gantt-container">
					{% for group, formations in grouped_formations %}
						<div class="group-header" onclick="toggleGroup('{{ group|e('html_attr') }}')">{{ group }}</div>
						<div id="group-{{ group|e('html_attr') }}">
							{% for formation in formations %}
								<div class="gantt-row">
									<div class="formation-name">
										{{ formation.nom }}<br>
										<small>{{ formation.titreProfessionnel }}</small>
									</div>
									<div class="formation-bar-container">
										{% set barLeft = date_service.getDaysBetween(start_date, formation.dateDebut) * dayWidth %}
										{% set barWidth = date_service.getDaysBetween(formation.dateDebut, formation.dateFin) * dayWidth %}
										<div class="formation-bar {{ formation.etat == 'validée' ? 'formation-validated' : 'formation-pending' }}" style="left: {{ barLeft }}px; width: {{ barWidth }}px" onclick="openFormationModal('{{ formation.id }}')" title="{{ formation.nom }} - {{ formation.dateDebut|date('d/m/Y') }} au {{ formation.dateFin|date('d/m/Y') }}"></div>

										{% for interruption in formation.interruptions %}
											{% set intLeft = date_service.getDaysBetween(formation.dateDebut, interruption.dateDebut) * dayWidth %}
											{% set intWidth = date_service.getDaysBetween(interruption.dateDebut, interruption.dateFin) * dayWidth %}
											<div class="interruption" style="left: {{ barLeft + intLeft }}px; width: {{ intWidth }}px"></div>
										{% endfor %}

										{% for periode in formation.periodEnEntreprises %}
											{% set entLeft = date_service.getDaysBetween(start_date, periode.dateDebut) * dayWidth %}
											{% set entWidth = date_service.getDaysBetween(periode.dateDebut, periode.dateFin) * dayWidth %}
											<div class="entreprise-period" style="left: {{ entLeft }}px; width: {{ entWidth }}px"></div>
										{% endfor %}
									</div>
								</div>
							{% endfor %}
						</div>
					{% endfor %}

					{% for holiday in holidays %}
						{% set left = date_service.getOffsetDaysBetween(start_date, holiday.date) * dayWidth %}
						<div class="holiday-marker" style="left: {{ left }}px" title="Jour férié: {{ holiday.nom }} ({{ holiday.date|date('d/m/Y') }})"></div>
					{% endfor %}

					<div class="today-marker" style="left: {{ current_day_position }}px" title="Aujourd'hui"></div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		function toggleGroup(groupId) {
const group = document.getElementById('group-' + groupId);
group.classList.toggle('group-collapsed');
}

// Open formation modal (placeholder)
function openFormationModal(id) {
alert("Vous avez cliqué sur la formation ID: " + id);
// Replace with modal or AJAX as needed
}

// Mouse drag scroll
const ganttScroll = document.getElementById('gantt-scroll-body');
let isDragging = false;
let startX,
startY,
scrollLeft,
scrollTop;

ganttScroll.addEventListener('mousedown', (e) => {
isDragging = true;
ganttScroll.classList.add('dragging');
startX = e.pageX - ganttScroll.offsetLeft;
startY = e.pageY - ganttScroll.offsetTop;
scrollLeft = ganttScroll.scrollLeft;
scrollTop = ganttScroll.scrollTop;
});

ganttScroll.addEventListener('mouseleave', () => {
isDragging = false;
});
ganttScroll.addEventListener('mouseup', () => {
isDragging = false;
});

ganttScroll.addEventListener('mousemove', (e) => {
if (! isDragging) 
return;



e.preventDefault();
const x = e.pageX - ganttScroll.offsetLeft;
const y = e.pageY - ganttScroll.offsetTop;
const walkX = (x - startX);
const walkY = (y - startY);
ganttScroll.scrollLeft = scrollLeft - walkX;
ganttScroll.scrollTop = scrollTop - walkY;
});
	</script>
{% endblock %}


{# {% extends 'base.html.twig' %}

{% block title %}Planning des Formations
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt@0.6.2/dist/frappe-gantt.min.css">
	<style>
		.gantt-container {
			margin: 0;
			font-family: Arial, sans-serif;
			/* overflow-x: auto;
            overflow-y: auto; */
			height: 60vh;
			position: relative;
			width: 1490px;
		}

		.timeline-header {
			position: sticky;
			top: 0;
			background: white;
			z-index: 100;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
		}

		.timeline-years,
		.timeline-months,
		.timeline-days {
			display: flex;
			height: 50px;
			border-bottom: 1px solid #ddd;
		}

		.year-column {
			font-weight: bold;
			border-right: 1px solid #ddd;
			display: flex;
			align-items: center;
			justify-content: center;
			background: #f8f9fc;
		}

		.month-column {
			min-width: 62px;
			font-size: 12px;
			border-right: 1px solid #eee;
			display: flex;
			align-items: center;
			justify-content: center;

		}

		.day-column {
			/* width: {{ dayWidth }}px; */
			font-size: 10px;
			text-align: left;
			border-right: 15px solid #eee;

		}

		.gantt-row {
			display: flex;
			align-items: center;
			height: 130px;
			border-bottom: 1px solid #eee;
			position: relative;
			background: #f8f9fc;
		}

		.formation-name {
			width: 250px;
			padding: 5px 10px;
			position: sticky;
			left: 0;
			background: #;
			z-index: 10;
			cursor: pointer;
		}

		.formation-bar-container {
			margin-left: 0;
			position: relative;
			min-width: calc(100% - 0px);
		}

		.formation-bar {
			position: absolute;
			height: 20px;
			background-color: #4e73df;
			border-radius: 3px;
			top: 10px;
		}

		.formation-validated {
			background-color: #28a745;
		}
		.formation-pending {
			background-color: orange;
		}
		.interruption {
			position: absolute;
			height: 20px;
			background-color: #e74a3b;
			opacity: 0.7;
			top: 10px;
		}
		.entreprise-period {
			position: absolute;
			height: 10px;
			background-color: #1cc88a;
			border-radius: 3px;
			top: 35px;
		}

		.holiday-marker,
		.today-marker {
			position: absolute;
			top: 0;
			bottom: 0;
			width: 2px;
			z-index: 5;
		}
		.holiday-marker {
			background-color: red;
		}
		.today-marker {
			background-color: blue;
		}

		.group-header {
			background-color: ;
			font-weight: bold;
			padding: 5px 10px;
			cursor: pointer;
		}

		.group-collapsed .gantt-row {
			display: none;
		}
	</style>
{% endblock %}

{% block body %}
	<div class="container-fluid">
		<h1 class="h3 mb-4 text-gray-800 text-center">Planning des Formations</h1>
		<div
			class="gantt-container">

			<!-- Timeline Header -->
			<div
				class="timeline-header">


				<!-- Année ou years -->
				<div class="timeline-years">
					{% set currentYear = '' %}
					{% for month in months %}
						{% set year = month|split('-')[0] %}
						{% if year != currentYear %}
							<div class="year-column" style="width: {{ months_in_year[year] * 62 }}px">{{ year }}</div>
							{% set currentYear = year %}
						{% endif %}
					{% endfor %}
				</div>


				<!-- Mois ou Months -->
				<div class="timeline-months">
					{% for month in months %}
						<div class="month-column">{{ month|split('-')[1]|month_name_fr }}</div>
					{% endfor %}
				</div>


				<!-- Jours or Days -->
				<div class="timeline-days">
					{% for month in months %}
						{% for day in 1..days_in_months[month] %}
							<div class="day-column">{{ day }}</div>
						{% endfor %}
					{% endfor %}
				</div>
			</div>

			<!-- Gantt Rows -->
			{% for group, formations in grouped_formations %}
				<div class="group-header" onclick="toggleGroup('{{ group|e('html_attr') }}')">{{ group }}</div>
				<div id="group-{{ group|e('html_attr') }}">
					{% for formation in formations %}


						<!-- Gantt rows sur chart -->
						<div class="gantt-row">
							<div class="formation-name">
								{{ formation.nom }}<br>
								<small>{{ formation.titreProfessionnel }}</small>
							</div>

							<!-- Gantt bar sur chart -->
							<div class="formation-bar-container">
								{% set barLeft = date_service.getDaysBetween(start_date, formation.dateDebut) * dayWidth %}
								{% set barWidth = date_service.getDaysBetween(formation.dateDebut, formation.dateFin) * dayWidth %}
								<div class="formation-bar {{ formation.etat == 'validée' ? 'formation-validated' : 'formation-pending' }}" style="left: {{ barLeft }}px; width: {{ barWidth }}px"></div>


								<!-- interruption -->
								{% for interruption in formation.interruptions %}
									{% set intLeft = date_service.getDaysBetween(formation.dateDebut, interruption.dateDebut) * dayWidth %}
									{% set intWidth = date_service.getDaysBetween(interruption.dateDebut, interruption.dateFin) * dayWidth %}
									<div class="interruption" style="left: {{ barLeft + intLeft }}px; width: {{ intWidth }}px"></div>
								{% endfor %}


								<!-- Period en Entreprises -->
								{% for periode in formation.periodEnEntreprises %}
									{% set entLeft = date_service.getDaysBetween(start_date, periode.dateDebut) * dayWidth %}
									{% set entWidth = date_service.getDaysBetween(periode.dateDebut, periode.dateFin) * dayWidth %}
									<div class="entreprise-period" style="left: {{ entLeft }}px; width: {{ entWidth }}px"></div>
								{% endfor %}
							</div>
						</div>
					{% endfor %}
				</div>
			{% endfor %}

			<!-- Holiday Markers -->
			<!-- Holiday Markers -->
			{% for holiday in holidays %}
				{% set left = date_service.getOffsetDaysBetween(start_date, holiday.date) * dayWidth %}
				<div class="holiday-marker" style="left: {{ left }}px" title="Jour férié: {{ holiday.nom }} ({{ holiday.date|date('d/m/Y') }})"></div>
			{% endfor %}

			<!-- Today Marker -->
			<div class="today-marker" style="left: {{ current_day_position }}px" title="Aujourd'hui"></div>
		</div>
	</div>
{% endblock %}

{% block javascripts %}
	{{ parent() }}
	<script>
		function toggleGroup(groupId) {
const group = document.getElementById('group-' + groupId);
group.classList.toggle('group-collapsed');
}
	</script>
{% endblock %} #}
